#!/bin/bash

usage() {
	echo "usage: ${progname} [options]"
	echo "options:"
	echo "       -f <filename>: display diff of a particular file"
	echo "       -F <flist>: file containing list of files to be diff'd"
	echo "       -o <outfile>: output file where diff will be stored (default stdout)"
	exit 1
}

progname=`basename $0`
if [ -z "${P4CLIENT}" -o -z "${P4CLIENT_DIR}" ]; then
	echo "Must be ran inside a view"
	exit 1
fi

filename=
flist=
outfile=
while getopts ":hf:F:o:" arg; do
	case $arg in
	f)	filename=${OPTARG}
		;;
	F)	flist=${OPTARG}
		;;
	o)	outfile=${OPTARG}
		;;
	*)	usage
		;;
	esac
done
if [ -n "${filename}" ]; then
	if [ -n "${outfile}" ]; then
		p4 diff -du ${filename} > ${outfile}
	else
		p4 diff -du ${filename} | less
	fi
elif [ -n "${flist}" ]; then
	if [ ! -f ${flist} ]; then
		echo "${progname}: missing ${flist}"
		exit 1
	fi
	files="`cat ${flist}`"
	for f in ${files}; do
		if [ -n "${outfile}" ]; then
			p4 diff -du ${f} >> ${outfile}
		else
			p4 diff -du ${f} | less
		fi
	done
else
	if [ -n "${outfile}" ]; then
		p4 diff -du > ${outfile}
	else
		p4 diff -du | less
	fi
fi
exit 0

